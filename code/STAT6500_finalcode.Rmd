---
title: "STAT6500 Final Project Supplemental Code"
author: "Shan Tang and Kyoko Yamaguchi"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: yeti
    highlight: kate
    toc: yes
  pdf_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Intro
## Packages
```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(tidyr)
library(Rtsne)
library(pals)
library(umap)
```

## Pseudocode for data download, wrangling, and cleaning
### Downloading HNSC methylation array data from GDC
```{r, eval=FALSE}
library(TCGAWorkflowData)
library(TCGAbiolinks)
library(SummarizedExperiment)

barcodeslist<-c(
"TCGA-P3-A6SX-01A-11D-A34K-05",
"TCGA-DQ-5629-01A-01D-1871-05",
"TCGA-CR-5248-01A-01D-2014-05",
"TCGA-DQ-5630-01A-01D-1871-05",
"TCGA-CV-A45T-01A-11D-A24I-05",
"TCGA-DQ-7591-01A-11D-2079-05",
"TCGA-CV-5432-01A-02D-1684-05",
"TCGA-CQ-A4CG-01A-11D-A265-05",
"TCGA-CV-A45R-01A-11D-A24I-05",
"TCGA-BA-5152-01A-02D-1871-05",
"TCGA-CN-5374-01A-01D-1433-05",
"TCGA-BA-5555-01A-01D-1511-05",
"TCGA-CN-6018-01A-11D-1684-05",
"TCGA-CV-6938-11A-01D-1913-05",
"TCGA-UF-A719-01A-12D-A34K-05",
"TCGA-BA-A6DF-01A-11D-A30F-05",
"TCGA-CV-7568-01A-11D-2230-05",
"TCGA-CR-7373-01A-11D-2014-05",
"TCGA-CN-A6V6-01A-12D-A34K-05",
"TCGA-BB-7866-01A-11D-2230-05",
"TCGA-CV-5443-01A-01D-1511-05",
"TCGA-T3-A92M-01A-31D-A392-05",
"TCGA-CQ-7067-01A-11D-2230-05",
"TCGA-QK-A64Z-01A-11D-A30F-05",
"TCGA-CV-A45P-01A-11D-A24I-05",
"TCGA-CV-7411-01A-11D-2079-05",
"TCGA-CV-A6JU-01A-11D-A31M-05",
"TCGA-CV-7406-01A-11D-2079-05",
"TCGA-IQ-A61K-01A-11D-A30F-05",
"TCGA-CV-A45V-01A-21D-A254-05",
"TCGA-CQ-6223-01A-11D-1913-05",
"TCGA-HD-8314-01A-11D-2398-05",
"TCGA-CR-6482-01A-11D-1871-05",
"TCGA-CV-7432-01A-11D-2130-05",
"TCGA-CV-5436-01A-01D-1511-05",
"TCGA-MZ-A7D7-01A-21D-A34K-05",
"TCGA-IQ-A61L-01A-11D-A30F-05",
"TCGA-CQ-5330-01A-01D-1684-05",
"TCGA-CV-5966-01A-11D-1684-05",
"TCGA-CR-7380-01A-11D-2014-05",
"TCGA-CV-7095-01A-21D-2014-05",
"TCGA-CV-7438-01A-21D-2130-05",
"TCGA-CR-7391-01A-11D-2014-05",
"TCGA-CV-7437-01A-21D-2130-05",
"TCGA-CQ-6225-01A-11D-1913-05",
"TCGA-CV-5435-01A-01D-1684-05",
"TCGA-CN-5356-01A-01D-1433-05",
"TCGA-CN-A6V1-01A-12D-A34K-05",
"TCGA-CQ-6219-01A-11D-1913-05",
"TCGA-BA-A6DE-01A-22D-A31M-05",
"TCGA-CV-6939-11A-01D-1913-05",
"TCGA-CV-7263-01A-11D-2014-05",
"TCGA-F7-A623-01A-11D-A28S-05",
"TCGA-D6-A4ZB-01A-11D-A254-05",
"TCGA-CV-5431-11A-01D-1511-05",
"TCGA-CQ-A4C6-01A-11D-A254-05",
"TCGA-UF-A7JS-01A-11D-A34K-05",
"TCGA-BA-5557-01A-01D-1511-05",
"TCGA-CQ-5323-01A-01D-1684-05",
"TCGA-CQ-5326-01A-01D-1871-05",
"TCGA-DQ-5624-01A-01D-1871-05",
"TCGA-D6-A6EN-01A-11D-A31M-05",
"TCGA-P3-A6T4-01A-11D-A34K-05",
"TCGA-BA-6871-01A-11D-1871-05",
"TCGA-CV-A461-01A-41D-A265-05",
"TCGA-IQ-7632-01A-11D-2079-05",
"TCGA-CQ-A4CI-01A-11D-A265-05",
"TCGA-F7-A620-01A-11D-A28S-05",
"TCGA-BA-A6DD-01A-12D-A31M-05",
"TCGA-CV-6962-01A-11D-1913-05",
"TCGA-CV-7248-01A-11D-2014-05",
"TCGA-BA-6872-01A-11D-1871-05",
"TCGA-BA-A6DG-01A-21D-A30F-05",
"TCGA-F7-8298-01A-11D-2398-05",
"TCGA-CR-6477-01A-11D-1871-05",
"TCGA-CQ-5325-01A-01D-1684-05",
"TCGA-CR-6480-01A-11D-1871-05",
"TCGA-CN-4728-01A-01D-1433-05",
"TCGA-DQ-7596-01A-11D-2230-05",
"TCGA-CV-5434-01A-01D-1684-05",
"TCGA-CN-6013-01A-11D-1684-05",
"TCGA-BA-A6DB-01A-11D-A30F-05",
"TCGA-CR-7377-01A-11D-2014-05",
"TCGA-CR-6487-01A-11D-1871-05",
"TCGA-CR-5247-01A-01D-2014-05",
"TCGA-CR-7390-01A-11D-2014-05",
"TCGA-HD-A6I0-01A-11D-A31M-05",
"TCGA-CV-7414-01A-11D-2079-05",
"TCGA-HD-8634-01A-11D-2398-05",
"TCGA-BA-5558-01A-01D-1511-05",
"TCGA-CV-7415-01A-11D-2079-05",
"TCGA-CR-7371-01A-11D-2014-05",
"TCGA-D6-8568-01A-11D-2398-05",
"TCGA-CN-A49A-01A-11D-A24I-05",
"TCGA-DQ-7592-01A-11D-2079-05",
"TCGA-CV-5441-01A-01D-1511-05",
"TCGA-HD-A634-01A-11D-A28S-05",
"TCGA-CR-6491-01A-11D-1871-05",
"TCGA-DQ-7594-01A-11D-2230-05",
"TCGA-P3-A6T0-01A-12D-A34K-05",
"TCGA-CV-6959-11A-01D-1913-05",
"TCGA-CV-5966-11A-01D-1684-05",
"TCGA-T3-A92N-01A-11D-A392-05",
"TCGA-CV-5976-11A-01D-1684-05",
"TCGA-CV-6441-01A-11D-1684-05",
"TCGA-T2-A6X0-01A-11D-A34K-05",
"TCGA-UF-A71E-01A-31D-A34K-05",
"TCGA-F7-A50J-01A-21D-A28S-05",
"TCGA-CV-6943-01A-11D-1913-05",
"TCGA-CN-4729-01A-01D-1433-05",
"TCGA-MT-A7BN-01A-12D-A34K-05",
"TCGA-CX-7086-01A-11D-2079-05",
"TCGA-CV-6433-11A-01D-1684-05",
"TCGA-CV-6936-11A-01D-1913-05",
"TCGA-CV-6933-01A-11D-1913-05",
"TCGA-BA-6873-01A-11D-1871-05",
"TCGA-CN-6022-01A-21D-1684-05",
"TCGA-QK-A6VC-01A-23D-A34K-05",
"TCGA-CV-7245-01A-11D-2014-05",
"TCGA-CV-6953-11A-01D-1913-05",
"TCGA-CV-5443-11A-01D-1511-05",
"TCGA-T2-A6X2-01A-12D-A34K-05",
"TCGA-CQ-5327-01A-01D-1684-05",
"TCGA-CV-7253-01A-11D-2014-05",
"TCGA-CN-5361-01A-01D-1433-05",
"TCGA-CV-5979-01A-11D-1684-05",
"TCGA-CV-6960-01A-41D-2014-05",
"TCGA-4P-AA8J-01A-11D-A392-05",
"TCGA-CN-4725-01A-01D-1433-05",
"TCGA-CV-7433-01A-11D-2130-05",
"TCGA-D6-6827-01A-11D-1913-05",
"TCGA-CR-5243-01A-01D-1511-05",
"TCGA-CN-6989-01A-11D-1913-05",
"TCGA-UF-A7JH-01A-21D-A34K-05",
"TCGA-CN-6024-01A-11D-1684-05",
"TCGA-CN-A641-01A-11D-A30F-05",
"TCGA-CV-7090-01A-11D-2014-05",
"TCGA-CV-5977-11A-01D-1684-05",
"TCGA-HD-7229-01A-11D-2014-05",
"TCGA-D6-6826-01A-11D-1913-05",
"TCGA-CV-7261-01A-11D-2014-05",
"TCGA-IQ-A61O-01A-11D-A30F-05",
"TCGA-BB-7862-01A-21D-2230-05",
"TCGA-QK-A652-01A-11D-A30F-05",
"TCGA-CV-6953-01A-11D-1913-05",
"TCGA-CN-A6V3-01A-12D-A34K-05",
"TCGA-IQ-A6SH-01A-12D-A34K-05",
"TCGA-CN-6019-01A-11D-1684-05",
"TCGA-CQ-5332-01A-01D-1684-05",
"TCGA-BA-4075-01A-01D-1433-05",
"TCGA-CR-7365-01A-11D-2014-05",
"TCGA-CR-6481-01A-11D-1871-05",
"TCGA-WA-A7GZ-01A-11D-A34K-05",
"TCGA-CV-A463-01A-11D-A265-05",
"TCGA-CV-7425-01A-11D-2079-05",
"TCGA-BA-A6DA-01A-31D-A31M-05",
"TCGA-CQ-A4CH-01A-11D-A265-05",
"TCGA-CV-7409-01A-31D-2230-05",
"TCGA-CV-5978-01A-11D-1684-05",
"TCGA-CQ-6218-01A-11D-1913-05",
"TCGA-CN-A63U-01A-11D-A30F-05",
"TCGA-CV-7254-01A-11D-2014-05",
"TCGA-IQ-A61J-01A-11D-A30F-05",
"TCGA-CR-7394-01A-11D-2014-05",
"TCGA-CV-7103-11A-01D-2014-05",
"TCGA-CR-6492-01A-12D-2079-05",
"TCGA-CV-7099-01A-41D-2014-05",
"TCGA-QK-A8ZA-01A-11D-A392-05",
"TCGA-UF-A7JJ-01A-11D-A34K-05",
"TCGA-CN-4723-01A-01D-1433-05",
"TCGA-P3-A5Q6-01A-11D-A28S-05",
"TCGA-MT-A51W-01A-21D-A265-05",
"TCGA-QK-A8Z9-01B-11D-A392-05",
"TCGA-P3-A5Q5-01A-11D-A28S-05",
"TCGA-BA-7269-01A-11D-2014-05",
"TCGA-BB-8596-01A-11D-2398-05",
"TCGA-CV-6954-11A-01D-1913-05",
"TCGA-CR-7376-01A-11D-2130-05",
"TCGA-CV-A460-01A-21D-A254-05",
"TCGA-CV-5444-01A-02D-1511-05",
"TCGA-CQ-A4CA-01A-11D-A254-05",
"TCGA-KU-A66T-01A-11D-A30F-05",
"TCGA-D6-A74Q-01A-11D-A34K-05",
"TCGA-BB-4223-01A-01D-1433-05",
"TCGA-CV-7235-11A-01D-2014-05",
"TCGA-BA-4078-01A-01D-1433-05",
"TCGA-UF-A7JF-01A-11D-A34K-05",
"TCGA-DQ-7588-01A-11D-2079-05",
"TCGA-CN-5365-01A-01D-1433-05",
"TCGA-TN-A7HJ-01A-12D-A34K-05",
"TCGA-CR-6493-01A-11D-1871-05",
"TCGA-IQ-A61E-01A-22D-A30F-05",
"TCGA-BA-A4IF-01A-11D-A265-05",
"TCGA-CV-6934-11A-01D-1913-05",
"TCGA-BA-A8YP-01A-11D-A392-05",
"TCGA-CV-6937-01A-11D-2014-05",
"TCGA-CR-6473-01A-11D-1871-05",
"TCGA-P3-A5QF-01A-11D-A28S-05",
"TCGA-CQ-5329-01A-01D-1684-05",
"TCGA-CN-5373-01A-01D-1433-05",
"TCGA-BB-4224-01A-01D-1433-05",
"TCGA-CV-6436-01A-11D-1684-05",
"TCGA-CN-4734-01A-01D-1433-05",
"TCGA-CQ-7071-01A-12D-A30F-05",
"TCGA-CV-A465-01A-11D-A265-05",
"TCGA-CN-4737-01A-01D-1433-05",
"TCGA-MT-A67D-01A-31D-A30F-05",
"TCGA-CR-7364-01A-11D-2014-05",
"TCGA-IQ-7630-01A-11D-2079-05",
"TCGA-CV-6942-01A-21D-2014-05",
"TCGA-MT-A51X-01A-11D-A265-05",
"TCGA-CV-7238-11A-01D-2014-05",
"TCGA-CN-5370-01A-01D-2014-05",
"TCGA-CN-4741-01A-01D-1433-05",
"TCGA-CR-7399-01A-11D-2014-05",
"TCGA-BA-5153-01A-01D-1433-05",
"TCGA-CR-7368-01A-11D-2130-05",
"TCGA-CQ-5331-01A-02D-1871-05",
"TCGA-BA-6870-01A-11D-1871-05",
"TCGA-CV-5444-11A-01D-1511-05",
"TCGA-QK-A6IH-01A-11D-A31M-05",
"TCGA-CQ-6227-01A-11D-1913-05",
"TCGA-CN-6997-01A-11D-2014-05",
"TCGA-CR-7397-01A-11D-2014-05",
"TCGA-MT-A67F-01A-11D-A30F-05",
"TCGA-CV-6945-01A-11D-1913-05",
"TCGA-CN-5369-01A-01D-1433-05",
"TCGA-RS-A6TO-01A-32D-A34K-05",
"TCGA-CV-6956-01A-21D-2064-05",
"TCGA-CR-7369-01A-11D-2130-05",
"TCGA-CV-5971-01A-11D-1684-05",
"TCGA-CV-6950-01A-11D-1913-05",
"TCGA-CV-5430-11B-01D-1684-05",
"TCGA-C9-A480-01A-12D-A24I-05",
"TCGA-F7-7848-01A-11D-2130-05",
"TCGA-CN-4740-01A-01D-1433-05",
"TCGA-CV-5431-01A-01D-1511-05",
"TCGA-CV-7250-11A-01D-2014-05",
"TCGA-CV-A6K1-01A-11D-A31M-05",
"TCGA-BA-A4IG-01A-11D-A265-05",
"TCGA-H7-8501-01A-11D-2398-05",
"TCGA-CV-A45O-01A-21D-A24I-05",
"TCGA-CV-7178-01A-21D-2014-05",
"TCGA-CN-A640-01A-21D-A30F-05",
"TCGA-BB-A5HZ-01A-21D-A28S-05",
"TCGA-CV-7100-01A-11D-2014-05",
"TCGA-IQ-A61H-01A-11D-A30F-05",
"TCGA-CQ-7063-01A-11D-2398-05",
"TCGA-CV-6952-11A-01D-1913-05",
"TCGA-CV-A6K2-01A-11D-A31M-05",
"TCGA-CV-5441-11A-01D-1511-05",
"TCGA-CV-7178-11A-01D-2014-05",
"TCGA-BA-A4II-01A-11D-A265-05",
"TCGA-H7-A6C5-01A-11D-A30F-05",
"TCGA-CV-7263-11A-01D-2014-05",
"TCGA-CV-A6JD-01A-11D-A31M-05",
"TCGA-CN-6988-01A-11D-1913-05",
"TCGA-CQ-7072-01A-21D-A30F-05",
"TCGA-CV-7103-01A-21D-2014-05",
"TCGA-CR-7393-01A-11D-2014-05",
"TCGA-DQ-7589-01A-11D-2230-05",
"TCGA-CV-6436-11A-01D-1684-05",
"TCGA-CN-4738-01A-02D-1511-05",
"TCGA-HD-7753-01A-11D-2079-05",
"TCGA-RS-A6TP-01A-12D-A34K-05",
"TCGA-CV-5442-11A-01D-1511-05",
"TCGA-CQ-5334-01A-01D-1684-05",
"TCGA-CV-5977-01A-11D-1684-05",
"TCGA-CV-6003-11A-01D-1684-05",
"TCGA-QK-A8Z8-01A-11D-A392-05",
"TCGA-D6-6517-01A-11D-1871-05",
"TCGA-QK-A6VB-01A-12D-A34K-05",
"TCGA-CR-7401-01A-11D-2014-05",
"TCGA-CV-A45Y-01A-11D-A254-05",
"TCGA-CN-4730-01A-01D-1433-05",
"TCGA-BB-A6UM-01A-12D-A34K-05",
"TCGA-CN-6020-01A-11D-1684-05",
"TCGA-CR-7367-01A-11D-2014-05",
"TCGA-IQ-7631-01A-11D-2079-05",
"TCGA-CQ-6229-01A-11D-1913-05",
"TCGA-CV-7255-01A-11D-2014-05",
"TCGA-CV-7238-01A-11D-2014-05",
"TCGA-P3-A6T2-01A-11D-A34K-05",
"TCGA-CV-A464-01A-11D-A265-05",
"TCGA-CR-7374-01A-11D-2014-05",
"TCGA-CN-4742-01A-02D-1511-05",
"TCGA-F7-A61S-01A-11D-A28S-05",
"TCGA-CV-7413-01A-11D-2079-05",
"TCGA-CV-7440-01A-11D-2130-05",
"TCGA-CN-4739-01A-02D-1511-05",
"TCGA-CR-6467-01A-11D-1871-05",
"TCGA-CQ-6224-01A-11D-1913-05",
"TCGA-BB-A6UO-01A-12D-A34K-05",
"TCGA-CN-A498-01A-11D-A24I-05",
"TCGA-UF-A7JD-01A-11D-A34K-05",
"TCGA-MT-A67A-01A-11D-A30F-05",
"TCGA-CV-7102-01A-11D-2014-05",
"TCGA-QK-AA3J-01A-11D-A392-05",
"TCGA-CV-7243-01A-11D-2014-05",
"TCGA-CV-7097-01A-11D-2014-05",
"TCGA-CV-7091-01A-11D-2014-05",
"TCGA-DQ-7595-01A-11D-2230-05",
"TCGA-CV-7089-01A-11D-2014-05",
"TCGA-CV-A6JE-01A-11D-A31M-05",
"TCGA-CV-7429-01A-11D-2130-05",
"TCGA-CR-5250-01A-01D-1511-05",
"TCGA-CR-7398-01A-11D-2014-05",
"TCGA-CV-6943-11A-01D-1913-05",
"TCGA-CN-A497-01A-11D-A24I-05",
"TCGA-CV-5978-11A-01D-1684-05",
"TCGA-F7-A61V-01A-11D-A28S-05",
"TCGA-CV-5973-11A-01D-1684-05",
"TCGA-CV-5970-01A-11D-1684-05",
"TCGA-BA-A4IH-01A-11D-A265-05",
"TCGA-BB-A5HU-01A-11D-A28S-05",
"TCGA-CN-6023-01A-11D-1684-05",
"TCGA-CX-A4AQ-01A-11D-A254-05",
"TCGA-CV-6962-11A-01D-1913-05",
"TCGA-BA-A6D8-01A-31D-A31M-05",
"TCGA-CV-6934-01A-11D-1913-05",
"TCGA-BA-4076-01A-01D-1433-05",
"TCGA-CV-6951-01A-11D-1913-05",
"TCGA-CV-6935-11A-01D-1913-05",
"TCGA-CV-7434-01A-11D-2130-05",
"TCGA-CV-6961-01A-21D-1913-05",
"TCGA-CR-6474-01A-11D-1871-05",
"TCGA-P3-A5QE-01A-11D-A28S-05",
"TCGA-UF-A7JA-01A-12D-A34K-05",
"TCGA-BB-7871-01A-11D-2230-05",
"TCGA-CV-5976-01A-11D-1684-05",
"TCGA-CR-6488-01A-12D-2079-05",
"TCGA-BA-6868-01B-12D-1913-05",
"TCGA-CV-A6JY-01A-11D-A31M-05",
"TCGA-CV-5439-01A-01D-1684-05",
"TCGA-CV-6936-01A-11D-1913-05",
"TCGA-D6-A6EO-01A-11D-A31M-05",
"TCGA-BA-4077-01B-01D-1433-05",
"TCGA-CQ-6220-01A-11D-1913-05",
"TCGA-CV-5432-11B-01D-1684-05",
"TCGA-CN-6996-01A-11D-1913-05",
"TCGA-CV-6938-01A-11D-1913-05",
"TCGA-P3-A6T5-01A-11D-A34K-05",
"TCGA-BA-A6DI-01A-11D-A30F-05",
"TCGA-CN-A63T-01A-11D-A28S-05",
"TCGA-HD-7754-01A-11D-2079-05",
"TCGA-D6-6515-01A-21D-1871-05",
"TCGA-MZ-A6I9-01A-11D-A31M-05",
"TCGA-CN-A63W-01A-11D-A30F-05",
"TCGA-CV-5430-01A-02D-1684-05",
"TCGA-CN-6011-01A-11D-1684-05",
"TCGA-CQ-A4C7-01A-11D-A254-05",
"TCGA-D6-A6EQ-01A-11D-A31M-05",
"TCGA-CR-6478-01A-11D-1871-05",
"TCGA-CX-7219-01A-11D-2014-05",
"TCGA-P3-A6T8-01A-11D-A34K-05",
"TCGA-CQ-7064-01A-11D-2398-05",
"TCGA-CV-5973-01A-11D-1684-05",
"TCGA-KU-A66S-01A-21D-A30F-05",
"TCGA-BB-7861-01A-11D-2230-05",
"TCGA-DQ-5625-01A-01D-1871-05",
"TCGA-CN-5363-01A-01D-1433-05",
"TCGA-H7-7774-01A-21D-2079-05",
"TCGA-CV-7435-01A-11D-2130-05",
"TCGA-CV-A45Q-01A-11D-A24I-05",
"TCGA-BB-7864-01A-11D-2230-05",
"TCGA-CR-7370-01A-11D-2130-05",
"TCGA-BA-5559-01A-01D-1511-05",
"TCGA-HD-A633-01A-11D-A28S-05",
"TCGA-UF-A7JC-01A-21D-A34K-05",
"TCGA-CV-6955-11A-01D-2014-05",
"TCGA-CN-5360-01A-01D-1433-05",
"TCGA-CN-4733-01A-02D-1871-05",
"TCGA-CR-7385-01A-11D-2014-05",
"TCGA-CV-7242-01A-11D-2014-05",
"TCGA-CV-5440-01A-01D-1511-05",
"TCGA-P3-A6T6-01A-11D-A34K-05",
"TCGA-CV-7247-01A-11D-2014-05",
"TCGA-CR-5249-01A-01D-1511-05",
"TCGA-CV-6941-01A-11D-1913-05",
"TCGA-CV-7410-01A-21D-2079-05",
"TCGA-CV-7250-01A-11D-2014-05",
"TCGA-CN-6012-01A-11D-1684-05",
"TCGA-KU-A6H8-01A-21D-A34K-05",
"TCGA-UF-A71B-01A-12D-A34K-05",
"TCGA-CV-A45Z-01A-21D-A254-05",
"TCGA-CV-6955-01A-11D-2064-05",
"TCGA-D6-A4Z9-01A-11D-A254-05",
"TCGA-CV-6940-01A-11D-1913-05",
"TCGA-WA-A7H4-01A-21D-A34K-05",
"TCGA-UF-A7JK-01A-11D-A34K-05",
"TCGA-CR-6484-01A-11D-1871-05",
"TCGA-CV-5971-11A-01D-1684-05",
"TCGA-CR-7402-01A-11D-2014-05",
"TCGA-F7-A50G-01A-11D-A265-05",
"TCGA-CR-7389-01A-11D-2014-05",
"TCGA-DQ-7590-01A-11D-2230-05",
"TCGA-CV-7180-01A-11D-2014-05",
"TCGA-CV-7101-11A-01D-2014-05",
"TCGA-BB-4227-01A-01D-1871-05",
"TCGA-CV-A45X-01A-21D-A254-05",
"TCGA-UF-A7JV-01A-11D-A34K-05",
"TCGA-CN-5367-01A-01D-1433-05",
"TCGA-CV-7245-11A-01D-2014-05",
"TCGA-KU-A6H7-06A-21D-A31M-05",
"TCGA-QK-A6IJ-01A-11D-A31M-05",
"TCGA-CN-6995-01A-31D-2014-05",
"TCGA-CR-7379-01A-11D-2014-05",
"TCGA-CN-A499-01A-11D-A24I-05",
"TCGA-D6-6824-01A-11D-1913-05",
"TCGA-CV-5442-01A-01D-1511-05",
"TCGA-CR-6470-01A-11D-1871-05",
"TCGA-T2-A6WZ-01A-21D-A34K-05",
"TCGA-CV-6935-01A-11D-1913-05",
"TCGA-CV-A6JN-01A-11D-A31M-05",
"TCGA-UF-A71D-01A-12D-A34K-05",
"TCGA-TN-A7HL-01A-11D-A34K-05",
"TCGA-H7-A6C4-01A-11D-A30F-05",
"TCGA-CV-5970-11A-01D-1684-05",
"TCGA-T2-A6WX-01A-12D-A34K-05",
"TCGA-CV-5434-11B-01D-1684-05",
"TCGA-BA-5149-01A-01D-1511-05",
"TCGA-CR-7392-01A-11D-2014-05",
"TCGA-QK-A8Z7-01A-11D-A392-05",
"TCGA-BB-4225-01A-01D-1433-05",
"TCGA-DQ-5631-01A-01D-1871-05",
"TCGA-UF-A7JO-01A-11D-A34K-05",
"TCGA-D6-A6EM-01A-21D-A31M-05",
"TCGA-QK-A6IG-01A-11D-A31M-05",
"TCGA-H7-8502-01A-11D-2398-05",
"TCGA-CN-4722-01A-01D-1433-05",
"TCGA-CV-7183-01A-11D-2014-05",
"TCGA-CV-A468-01A-11D-A265-05",
"TCGA-MZ-A5BI-01A-31D-A34K-05",
"TCGA-CR-6472-01A-11D-1871-05",
"TCGA-CN-6021-01A-11D-1684-05",
"TCGA-CN-6017-01A-11D-1684-05",
"TCGA-MT-A67G-01A-11D-A30F-05",
"TCGA-BA-6869-01A-11D-1871-05",
"TCGA-D6-A6EP-01A-11D-A31M-05",
"TCGA-BA-A6DJ-01A-11D-A30F-05",
"TCGA-CV-7177-01A-11D-2014-05",
"TCGA-BB-A5HY-01A-11D-A28S-05",
"TCGA-CN-5364-01A-01D-1433-05",
"TCGA-P3-A6T7-01A-11D-A34K-05",
"TCGA-CN-A6V7-01A-12D-A34K-05",
"TCGA-CV-5439-11B-01D-1684-05",
"TCGA-F7-A61W-01A-11D-A28S-05",
"TCGA-CR-7395-01A-11D-2014-05",
"TCGA-CR-6471-01A-11D-1871-05",
"TCGA-QK-A8ZB-01A-11D-A392-05",
"TCGA-D6-A6ES-01A-12D-A31M-05",
"TCGA-CN-A49C-01A-11D-A24I-05",
"TCGA-D6-A6EK-01A-11D-A31M-05",
"TCGA-CN-A63Y-01A-11D-A30F-05",
"TCGA-QK-AA3K-01A-11D-A392-05",
"TCGA-CV-5435-11B-01D-1684-05",
"TCGA-BB-7872-01A-11D-2230-05",
"TCGA-HD-A4C1-01A-11D-A24I-05",
"TCGA-CN-4735-01A-01D-1433-05",
"TCGA-CN-A6UY-01A-12D-A34K-05",
"TCGA-QK-A6IF-01A-11D-A31M-05",
"TCGA-D6-8569-01A-11D-2398-05",
"TCGA-CV-7446-01A-11D-2230-05",
"TCGA-UF-A7J9-01A-12D-A34K-05",
"TCGA-CV-6441-11A-01D-1684-05",
"TCGA-D6-6825-01A-21D-1913-05",
"TCGA-P3-A6SW-01A-11D-A34K-05",
"TCGA-CN-6992-01A-11D-1913-05",
"TCGA-CV-6952-01A-11D-1913-05",
"TCGA-BA-4074-01A-01D-1433-05",
"TCGA-HD-7917-01A-11D-2230-05",
"TCGA-CV-6954-01A-11D-1913-05",
"TCGA-BB-4228-01A-01D-1433-05",
"TCGA-CQ-A4CD-01A-21D-A254-05",
"TCGA-CN-A642-01A-12D-A30F-05",
"TCGA-CQ-6221-01A-11D-2079-05",
"TCGA-CV-6939-01A-11D-1913-05",
"TCGA-KU-A6H7-01A-11D-A31M-05",
"TCGA-CV-7423-01A-11D-2079-05",
"TCGA-CV-7235-01A-11D-2014-05",
"TCGA-CV-7428-01A-11D-2130-05",
"TCGA-D6-6516-01A-11D-1871-05",
"TCGA-CR-7382-01A-11D-2130-05",
"TCGA-BB-4217-01A-11D-2079-05",
"TCGA-HD-7832-01A-11D-2130-05",
"TCGA-CR-7383-01A-11D-2130-05",
"TCGA-CQ-6222-01A-11D-1913-05",
"TCGA-CN-A49B-01A-31D-A24I-05",
"TCGA-CQ-7068-01A-11D-2079-05",
"TCGA-CV-5436-11A-01D-1511-05",
"TCGA-CR-7372-01A-11D-2014-05",
"TCGA-HD-A6HZ-01A-12D-A31M-05",
"TCGA-CV-7407-01A-11D-2079-05",
"TCGA-CV-7416-01A-11D-2079-05",
"TCGA-CN-4727-01A-01D-1433-05",
"TCGA-D6-6823-01A-11D-1913-05",
"TCGA-UP-A6WW-01A-12D-A34K-05",
"TCGA-CR-7388-01A-11D-2014-05",
"TCGA-CN-5358-01A-01D-1511-05",
"TCGA-CQ-7069-01A-11D-2398-05",
"TCGA-CV-6951-11A-01D-1913-05",
"TCGA-IQ-A6SG-01A-12D-A34K-05",
"TCGA-CV-7424-01A-11D-2079-05",
"TCGA-BB-7863-01A-11D-2230-05",
"TCGA-CV-A6JO-01B-11D-A34K-05",
"TCGA-CN-6998-01A-23D-2014-05",
"TCGA-P3-A6T3-01A-11D-A34K-05",
"TCGA-CV-7421-01A-11D-2079-05",
"TCGA-CQ-5333-01A-01D-2398-05",
"TCGA-BA-A6DL-01A-21D-A30F-05",
"TCGA-CV-7422-01A-21D-2079-05",
"TCGA-CQ-5324-01A-01D-1684-05",
"TCGA-IQ-A61I-01A-11D-A30F-05",
"TCGA-CV-6933-11A-01D-1913-05",
"TCGA-CR-7404-01A-11D-2130-05",
"TCGA-CV-A6JM-01A-11D-A31M-05",
"TCGA-CV-6956-11A-01D-2014-05",
"TCGA-CV-5979-11A-01D-1684-05",
"TCGA-HD-8635-01A-11D-2398-05",
"TCGA-CN-6010-01A-11D-1684-05",
"TCGA-CV-6961-11A-01D-1913-05",
"TCGA-CV-A6JZ-01A-11D-A31M-05",
"TCGA-F7-A622-01A-11D-A28S-05",
"TCGA-F7-A50I-01A-11D-A28S-05",
"TCGA-CQ-A4CE-01A-11D-A265-05",
"TCGA-CV-A45W-01A-11D-A254-05",
"TCGA-CN-A63V-01A-11D-A28S-05",
"TCGA-HD-7831-01A-11D-2130-05",
"TCGA-CR-7386-01A-11D-2014-05",
"TCGA-CV-A6K0-01B-21D-A31M-05",
"TCGA-BA-5556-01A-01D-1511-05",
"TCGA-QK-A6V9-01A-11D-A34K-05",
"TCGA-CQ-A4CB-01A-11D-A254-05",
"TCGA-UF-A718-01A-22D-A34K-05",
"TCGA-CX-7085-01A-21D-2014-05",
"TCGA-CV-7418-01A-11D-2079-05",
"TCGA-CV-6959-01A-11D-1913-05",
"TCGA-CV-7252-01A-11D-2014-05",
"TCGA-CV-6948-01A-11D-1913-05",
"TCGA-CN-4726-01A-01D-1433-05",
"TCGA-CV-7101-01A-11D-2014-05",
"TCGA-CV-7089-11A-01D-2014-05",
"TCGA-CQ-6228-01A-11D-1913-05",
"TCGA-CV-7427-01A-11D-2079-05",
"TCGA-CV-7430-01A-11D-2130-05",
"TCGA-CN-5359-01A-01D-1433-05",
"TCGA-P3-A5QA-01A-11D-A28S-05",
"TCGA-HD-8224-01A-11D-2398-05",
"TCGA-BB-8601-01A-11D-2398-05",
"TCGA-CV-7255-11A-01D-2014-05",
"TCGA-CV-7104-01A-11D-2014-05",
"TCGA-CV-6003-01A-11D-1684-05",
"TCGA-F7-8489-01A-31D-2398-05",
"TCGA-TN-A7HI-01A-11D-A34K-05",
"TCGA-CX-7082-01A-11D-2014-05",
"TCGA-CQ-A4C9-01A-11D-A254-05",
"TCGA-DQ-7593-01A-11D-2230-05",
"TCGA-HL-7533-01A-11D-2230-05",
"TCGA-BB-7870-01A-11D-2230-05",
"TCGA-QK-A6II-01A-11D-A31M-05",
"TCGA-CV-6433-01A-11D-1684-05",
"TCGA-CQ-7065-01A-11D-2079-05",
"TCGA-C9-A47Z-01A-11D-A24I-05",
"TCGA-IQ-A61G-01A-11D-A30F-05",
"TCGA-H7-A76A-01A-51D-A34K-05",
"TCGA-CN-6016-01A-11D-1684-05",
"TCGA-UF-A71A-06A-11D-A392-05",
"TCGA-CV-7236-01A-11D-2014-05",
"TCGA-CV-A45U-01A-12D-A24I-05",
"TCGA-BA-5151-01A-01D-1433-05",
"TCGA-CN-4731-01A-01D-1433-05",
"TCGA-CN-5366-01A-01D-1433-05",
"TCGA-CN-5355-01A-01D-1433-05",
"TCGA-CN-4736-01A-01D-1433-05",
"TCGA-UF-A71A-01A-22D-A34K-05",
"TCGA-CN-6994-01A-11D-1913-05",
"TCGA-CV-A6JT-01A-11D-A31M-05",
"TCGA-F7-A624-01A-22D-A30F-05",
"TCGA-CV-5440-11A-01D-1511-05",
"TCGA-UF-A7JT-01A-11D-A34K-05"
)

query.met.test <- GDCquery(
  project = "TCGA-HNSC", 
  legacy = TRUE,
  data.category = "DNA methylation",
  platform = "Illumina Human Methylation 450", 
  barcode = barcodeslist
)
GDCdownload(query.met.test)

RAW <- GDCprepare(
  query = query.met.test,
  save = FALSE, 
  # save.filename = "C:/Users/yama16/Desktop/20210927/downloads/hnscDNAmet450k.rda",
  summarizedExperiment = TRUE
)


# Drop CPGs that have greater than X% NAs in the row 
# (as in, X% or more of patients have "NA" values for these CGs)
mycutoff<-0.3
cutoffrowna<-mycutoff*ncol(RAW)
numberofna<-which(rowSums(is.na(RAW))/cutoffrowna > mycutoff)
RAW_cutoffna<-RAW[-numberofna,]
dim(RAW_cutoffna)

# Impute the rows that have X% or less missing
meanimputation <- function(x) {x[is.na(x)] <- mean(x, na.rm=TRUE); return(x)}
RAW_cutoffna_impute  <- as.data.frame(apply(RAW_cutoffna, 1, meanimputation ))
RAW_cutoffna_impute<-t(RAW_cutoffna_impute)

# Keep top 1000 most variably expressed CPGs
cutoff_top1000<-min(head(sort(rowSds(RAW_cutoffna_impute), decreasing=TRUE),1000))
keepers_top1000<-which(rowSds(RAW_cutoffna_impute) >= cutoff_top1000)
RAW_cutoffna_impute_top1000<-RAW_cutoffna_impute[keepers_top1000,]
dim(RAW_cutoffna_impute_top1000)
write.csv(RAW_cutoffna_impute_top1000, "hnsc_cpg1000.csv")
```


### Downloading and wrangling clinical table

```{r, eval=FALSE}
query <- GDCquery(project = "TCGA-HNSC", 
                  data.category = "Clinical",
                  data.type = "Clinical Supplement", 
                  data.format = "BCR Biotab")
GDCdownload(query)
clinical.BCRtab.all <- GDCprepare(query)
names(clinical.BCRtab.all)


# Drop the first two rows of all the tables
functdropfirsttwo<-function(x){
  y<-x[-c(1:2),]
  return (y)
}
clinical.BCRtab.all2<-lapply(clinical.BCRtab.all, functdropfirsttwo)


# Not available, not applicable, unknown, not evaluated are all stored within [] and turned into NA
turntoNA <- function(x) {
  a <- grep("\\[", x)
  vec <- rep(TRUE, length(x))
  vec[a] <- NA
  x <- x[vec]
  return(x)
}

clinical.BCRtab.all2$clinical_follow_up_v4.8_hnsc<-apply(clinical.BCRtab.all2$clinical_follow_up_v4.8_hnsc, 2,
                                                         function(x) turntoNA(x))  %>% as.data.frame()
clinical.BCRtab.all2$clinical_radiation_hnsc<-apply(clinical.BCRtab.all2$clinical_radiation_hnsc, 2, 
                                                    function(x) turntoNA(x))  %>% as.data.frame()
clinical.BCRtab.all2$clinical_patient_hnsc<-apply(clinical.BCRtab.all2$clinical_patient_hnsc, 2, 
                                                  function(x) turntoNA(x))  %>% as.data.frame()
clinical.BCRtab.all2$clinical_drug_hnsc<-apply(clinical.BCRtab.all2$clinical_drug_hnsc, 2, 
                                               function(x) turntoNA(x))  %>% as.data.frame()

# Add prefix to beginning of names to make the source identifiable:
colnames(clinical.BCRtab.all2$clinical_follow_up_v4.8_hnsc) <-
  paste("fu48",colnames(clinical.BCRtab.all2$clinical_follow_up_v4.8_hnsc),sep="-")
colnames(clinical.BCRtab.all2$clinical_radiation_hnsc) <-
  paste("rad",colnames(clinical.BCRtab.all2$clinical_radiation_hnsc),sep="-")
colnames(clinical.BCRtab.all2$clinical_patient_hnsc) <-
  paste("patient",colnames(clinical.BCRtab.all2$clinical_patient_hnsc),sep="-")
colnames(clinical.BCRtab.all2$clinical_drug_hnsc) <-
  paste("drug",colnames(clinical.BCRtab.all2$clinical_drug_hnsc),sep="-")

# Trying to make each one unique to the "bcr_patient_barcode"
patient<-clinical.BCRtab.all2$clinical_patient_hnsc
rad<-clinical.BCRtab.all2$clinical_radiation_hnsc
drug<-clinical.BCRtab.all2$clinical_drug_hnsc
fu48<-clinical.BCRtab.all2$clinical_follow_up_v4.8_hnsc


# Radiation for primary tumor field prioritized over other regions:
# Extract rad therapy best response (relevant column)
rad2<-rad[,c("rad-bcr_patient_barcode","rad-treatment_best_response","rad-radiation_therapy_site")]
rad3<-distinct(rad2)
rad3$`rad-radiation_therapy_site` %>% table()
rad4<-rad3[which(rad3$`rad-radiation_therapy_site`=="Primary Tumor Field"),]
radfinal<-rad4


# drug reduce to 186 or fewer
drug2<-drug[,c("drug-bcr_patient_barcode","drug-pharmaceutical_therapy_type")] %>%distinct() 
drug2$chemoyes<-ifelse(drug2$`drug-pharmaceutical_therapy_type` =="Chemotherapy", "Y", NA)
drug3<-drug2[,c(1,3)] %>% drop_na() %>% distinct()
drug3$`drug-bcr_patient_barcode` %>% length()
drugfinal<-drug3

# Wranlg the follow up 48 table
which(is.na(fu48$`fu48-treatment_outcome_first_course`))
test<-fu48[which(is.na(fu48$`fu48-treatment_outcome_first_course`)),c("fu48-bcr_patient_barcode","fu48-form_completion_date","fu48-treatment_outcome_first_course")]
interestedincols<-c("fu48-bcr_patient_barcode",
"fu48-form_completion_date",
"fu48-vital_status",
"fu48-death_days_to",
"fu48-tumor_status",
"fu48-treatment_outcome_first_course",
"fu48-tobacco_smokeless_use_at_dx")
fu48_2<-fu48[,interestedincols] %>% distinct()


# prioritize the last followup date:
fu48_2$combined<-paste(fu48_2$`fu48-bcr_patient_barcode`,fu48_2$`fu48-form_completion_date`,sep="_") 
fu48_2$combined %>% unique() %>% length()
fu48_2[order(fu48_2$combined, decreasing = FALSE),]


# days elapsed since reference date
fu48_2$`fu48-form_completion_date` - as.Date("2012-01-01")
fu48_2$daysinceref<-as.numeric(as.Date(fu48_2$`fu48-form_completion_date`)- as.Date("2012-01-01"), units="days")
fu48_max<-fu48_2 %>% group_by(`fu48-bcr_patient_barcode`) %>% dplyr::filter(daysinceref == max(daysinceref))
fu48_min<-fu48_2 %>% group_by(`fu48-bcr_patient_barcode`) %>% dplyr::filter(daysinceref == min(daysinceref))


# All left join to clinical.BCRtab.all2$clinical_patient_hnsc dataset
leftjoin1<-patient %>% left_join(fu48_max, by=c("patient-bcr_patient_barcode"="fu48-bcr_patient_barcode"))
leftjoin2<-leftjoin1 %>% left_join(radfinal, by=c("patient-bcr_patient_barcode"="rad-bcr_patient_barcode"))
leftjoin3<-leftjoin2 %>% left_join(drugfinal, by=c("patient-bcr_patient_barcode"="drug-bcr_patient_barcode"))

write.csv(leftjoin3, file="clinicaltablesmall.csv")
```


### Further cleaning and sorting of methylation array and clinical tables
```{r, eval=FALSE}
cpgcsv<-read.csv(file="hnsc_cpg1000.csv", row.names = 1)
clincsv<-read.csv(file="clinicaltablesmall.csv", row.names = 1)

rownames(clincsv)<-clincsv$patient.bcr_patient_barcode #change the rownames for clinical table

ptnames<-colnames(cpgcsv)
splitted<-strsplit(ptnames, split="\\.")

joinednames<-rep(NA, length(splitted))
for (i in 1: length(splitted)){
  joinednames[i]<-paste(splitted[[i]][1], splitted[[i]][2], splitted[[i]][3], sep="-")
}

# We see that the joinednames are NOT all unique
length(unique(joinednames))

# Exploring what the fourth element of the list stores
v<-rep(NA, length(splitted))

for (i in 1:length(splitted)) {
 v[i]<- splitted[[i]][4]
}
table(v)


# We are keeping only the patient samples marked "01A" or "01B" since these are the primary tumor samples
v2<-rep(NA, length(splitted))

for (i in 1:length(splitted)){
  if(splitted[[i]][4]=="01A"|splitted[[i]][4]=="01B"){
    v2[i]<-"include"
  }
  else{
    v2[i]<-"exclude"
  }
}


splittedsubset<-splitted[which(v2=="include")]

newjoinednames<-rep(NA, length(splittedsubset))
for (i in 1: length(splittedsubset)){
  newjoinednames[i]<-paste(splittedsubset[[i]][1], splittedsubset[[i]][2], splittedsubset[[i]][3], sep="-")
}

intersect(newjoinednames, rownames(clincsv)) %>% length() #sanity check


# the indexes for "include" are the ones we should keep
newcpgcsv<-cpgcsv[,which(v2=="include")]
newcpgcsvT<-t(newcpgcsv)
newcpgcsvT<-as.data.frame(newcpgcsvT)
rownames(newcpgcsvT)<-newjoinednames

# order the rownames based on alphabetical order of one of them to make sure they're the same order
o1<-order(rownames(clincsv))
sortedclin<-clincsv[o1,]
o2<-order(rownames(newcpgcsvT))
sortedcpg<-newcpgcsvT[o2,]
match(rownames(sortedclin), rownames(sortedcpg)) # sanity check

# exporting out the FINAL cleaned tables
saveRDS(sortedclin, file="../data/hnsc_clin_sorted.RDS")
saveRDS(sortedcpg, file="../data/hnsc_cpg1000_sorted.RDS")
```


## Read in files
```{r}
sortedcpg<-readRDS(file="../data/hnsc_cpg1000_sorted.RDS")
```

# Using the original matrix of CpGs to find clusters
## Dimension reduction of cpgs using TSNE
```{r}
set.seed(123)
cpgtsne<-Rtsne(sortedcpg, perplexity=15, exaggeration_factor=5)$Y
```

```{r}
par(pty="s")
plot(cpgtsne, xlab= "TSNE dimension 1", ylab="TSNE dimension 2")
```

From the above, it appears there are about 5 clusters, maybe 6.

```{r}
library(Mercator)
library(clValid)
```

## clValid to approximate number of clusters for kmeans and pam
clValid can compare internal validation metrics between Kmeans, hierarchical, and pam clustering for different values of K.
```{r}
myclmethods<-c("kmeans", "pam")
clvalidres<-clValid(sortedcpg, nClust=2:6, clMethods = myclmethods, validation="internal")
```

```{r}
clvalidres@measures
```
```{r}
plot(clvalidres)
```
```{r}
summary(clvalidres)
```

Connectivity should be minimized; Dunn index should be maximized; Silhouette width should be maximized.

```{r}
# setting what range of k to explore
myK<-seq(from=2, to=6, by=1)
```

## kmeans
```{r}
mykmeansclusters <-matrix(NA, ncol=length(myK), nrow=nrow(sortedcpg))

for (i in 1:length(myK)){
  mykmeansres = kmeans(x=as.matrix(sortedcpg), centers=myK[i], 
                                 iter.max = 10, nstart = 1,
       algorithm = c("Hartigan-Wong"), trace=FALSE)
  mykmeansclusters [,i] <-mykmeansres$cluster
}

colnames(mykmeansclusters)<-paste("Kmeans",myK, sep="_")
```


## kmedoids (PAM)
res_pam2<-pam(x=LFt, k=2, metric = "euclidean", stand = FALSE)
```{r}
mypamclusters <-matrix(NA, ncol=length(myK), nrow=nrow(sortedcpg))

for (i in 1:length(myK)){
  mypamres = pam(x=as.matrix(sortedcpg), k=myK[i], 
                 metric = "euclidean", stand = FALSE)
  mypamclusters [,i] <-mypamres$clustering
}

colnames(mypamclusters)<-paste("PAM",myK, sep="_")
```

## kernlab::specc (spectral clustering)
```{r}
library(kernlab)
```

```{r}
myspeccclusters <-matrix(NA, ncol=length(myK), nrow=nrow(sortedcpg))

for (i in 1:length(myK)){
  myspeccres<-specc(as.matrix(sortedcpg), centers=myK[i])
  myspeccclusters [,i] <-myspeccres@.Data
}

colnames(myspeccclusters)<-paste("specc",myK, sep="_")
```


### Using the eigengap heuristic to estimate number of clusters

```{r}
library(KRLS)
```
```{r}
cpgsimilarity<-gausskernel(X = sortedcpg, sigma = 20)
```


```{r}
library(Spectrum)
estimate_k(cpgsimilarity)
```


## Combining all the clusters tables into 1

```{r}
clustersbig<-cbind(mykmeansclusters, mypamclusters, myspeccclusters)
rownames(mykmeansclusters)<-rownames(sortedcpg)
```

## Cluster colors overlayed on TSNE

```{r, out.width="50%"}
par(pty="s")

for (i in 1:ncol(clustersbig)){
  
  plot(x=cpgtsne[,1], y=cpgtsne[,2], 
     bg=glasbey()[clustersbig[,i]], pch=21, cex=1.2,
     xlab="t-SNE dimension 1",ylab="t-SNE dimension 2",
     main=colnames(clustersbig)[i])
}

```


# Using Jaccard distance matrix to find patient clusters

## Computing the Jaccard distance

```{r}
myjacc<-binaryDistance(t(sortedcpg), metric="jaccard")
set.seed(123)
myjacctsne<-Rtsne(myjacc, perplexity=15, exaggeration_factor=10)
```

Uncolored TNSE:
```{r}
par(mfrow=c(1,2), pty="s")
plot(myjacctsne$Y, xlab="t-SNE dimension 1",ylab="t-SNE dimension 2",
     main="t-SNE on Jaccard distance")
```

## Exploring the Jaccard distance matrix

```{r}
# dimensions?
dim(as.matrix(myjacc))
matjacc<-as.matrix(myjacc)
hist(colMeans(matjacc))
```

Symmetric matrix (nxn) 


## kmeans

```{r}
mykmeansclusters <-matrix(NA, ncol=length(myK), nrow=nrow(sortedcpg))

for (i in 1:length(myK)){
  mykmeansres = kmeans(x=myjacc, centers=myK[i], 
                                 iter.max = 10, nstart = 1,
       algorithm = c("Hartigan-Wong"), trace=FALSE)
  mykmeansclusters [,i] <-mykmeansres$cluster
}

colnames(mykmeansclusters)<-paste("Kmeans",myK, sep="_")
```

## kmedoids (PAM)

```{r}
mypamclusters <-matrix(NA, ncol=length(myK), nrow=nrow(sortedcpg))

for (i in 1:length(myK)){
  mypamres = pam(x=myjacc, k=myK[i], 
                 metric = "euclidean", stand = FALSE)
  mypamclusters [,i] <-mypamres$clustering
}

colnames(mypamclusters)<-paste("PAM",myK, sep="_")
```

## kernlab::specc (spectral clustering)
```{r}
library(kernlab)
```

```{r}
myspeccclusters <-matrix(NA, ncol=length(myK), nrow=nrow(sortedcpg))

for (i in 1:length(myK)){
  myspeccres<-specc(as.matrix(myjacc), centers=myK[i])
  myspeccclusters [,i] <-myspeccres@.Data
}

colnames(myspeccclusters)<-paste("specc",myK, sep="_")
```


## Combining all the clusters tables into 1

```{r}
clustersbig<-cbind(mykmeansclusters, mypamclusters, myspeccclusters)
rownames(mykmeansclusters)<-rownames(sortedcpg)
```

## Cluster colors overlayed on TSNE
```{r}
# legend
plot(NULL ,xaxt='n',yaxt='n',bty='n',ylab='',xlab='', xlim=0:1, ylim=0:1)
legend("topleft", 
       legend = unique(1:max(myK))%>%sort(),
    pch=16, pt.cex=3, cex=2, bty='n',
    col = unique(glasbey()[1:max(myK)]) )
mtext("Clusters", at=0.2, cex=2)
```


```{r, out.width="50%"}
par(pty="s")

for (i in 1:ncol(clustersbig)){
  plot(x=myjacctsne$Y[,1], y=myjacctsne$Y[,2], 
     bg=glasbey()[clustersbig[,i]], pch=21, cex=1.2,
     xlab="t-SNE dimension 1",ylab="t-SNE dimension 2",
     main=colnames(clustersbig)[i])
}

```

Save cluster calls with from PAM K=3 using Jaccard distance:

```{r}
clustersfinal<-clustersbig[,"PAM_3"]
```

```{r}
saveRDS(clustersfinal, "../data/clustersfinal.RDS")
saveRDS(clustersbig,"../data/clustersbig.RDS")
```

## What do the Silhouette widths look like for the clusters found using Jaccard distance?

```{r}
library(factoextra)
library(cluster)
```

```{r}
for (i in 1:ncol(clustersbig)){
  
sil<-silhouette(clustersbig[,i], myjacc)
fvizsil<-fviz_silhouette(sil, palette=glasbey(), main=colnames(clustersbig)[i], print.summary = FALSE)
# this prints the information for data.frame in a more readable format, with more sigfigs
fvizdata<-fvizsil$data
print(colnames(clustersbig)[i])
print(tapply(fvizdata$sil_width, fvizdata$cluster, mean))
print(sum(tapply(fvizdata$sil_width, fvizdata$cluster, mean)))
# this is to get rid of the annoying red dashed line representing the average silwidth
yint0<-data.frame("yintercept"= 0)
fvizsil$layers[[2]]$data<-yint0
fvizsil$layers[[2]]$aes_params$colour <- "black"
fvizsil$layers[[2]]$aes_params$linetype <- "solid"
print(fvizsil)
  
}
```

# Exploring relationship between final cluster calls and clinical variables

## Libraries and reading in files

```{r, include=FALSE}
sortedcpg<-readRDS("../data/hnsc_cpg1000_sorted.RDS")
sortedclin<-readRDS("../data/hnsc_clin_sorted.RDS")
clusterfinal<-readRDS("../data/clustersfinal.RDS")
clusterbig<-readRDS("../data/clustersbig.RDS")
```

## Clinical data sort
```{r pressure, include=F}
numlevels<-apply(sortedclin, 2, function(x) length(unique(x)))
# sort(numlevels)
names(numlevels)[which(numlevels<=6)]

interesting<-names(numlevels)[which(numlevels<=6)]
interestingimportant<-c(interesting, "patient.birth_days_to", "patient.death_days_to")
subsetclin<-sortedclin[,interestingimportant]

clin_sub<-subsetclin %>% 
  mutate(patient.age_year= round(-as.numeric(patient.birth_days_to)/365, 2),
         patient.event=sortedclin$patient.vital_status %>% as.factor() %>% as.numeric() -1,  #Alive=0,Dead=1
         patient.survDays=rowSums(sortedclin[, 
                        c("patient.last_contact_days_to","patient.death_days_to")], na.rm=T))
write.csv(clin_sub,"../data/clin_sub.csv", row.names = F)
```


```{r}
clin_sub<-read.csv("../data/clin_sub.csv", header = T)
```


## Forest plot
```{r}
require("survival")
library("survminer")
library(ggpubr)

plot.ggsurv<- function(surv.fit, clin.table) {
  ggsurv<-ggsurvplot(fit =surv.fit, clin.table,
           palette = c("#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7"),
           pval = TRUE, #conf.int = TRUE, 
           legend=c(0.7,0.85),legend.title = "Patient Group",
           xlab = "Time/days", 
           ggtheme = theme_light())
  
  ggsurv$plot <- ggsurv$plot + 
    theme(legend.text = element_text(size = 16, color = "black"),
          axis.title.x =  element_text(size = 16, color = "black"),
          axis.title.y =  element_text(size = 16, color = "black"))
  
  return(ggsurv)
}
```

#### for pam-3
```{r}
clin_sub$clustersfinal<-as.factor(clusterfinal)
fit_clusters<- survfit(Surv(patient.survDays, patient.event) ~ clustersfinal, clin_sub)
surv_object <- Surv(time = clin_sub$patient.survDays, event = clin_sub$patient.event)
fit.coxph <- coxph(surv_object ~ clustersfinal, data = clin_sub)

ggforest(fit.coxph, data = clin_sub)
plot.ggsurv(fit_clusters,clin_sub)
```

#### for multiple subgroup
```{r}
library(gridExtra)

clin_sub1<-clin_sub
par(mfrow=c(5,3))
forest_p<-list()
for (i in 1:ncol(clusterbig)) {
  clin_sub1$cluster<-as.factor(clusterbig[,i])
  colnames(clin_sub1)[ncol(clin_sub1)] <- colnames(clusterbig)[i]
  #fit_clusters<- survfit(Surv(patient.survDays, patient.event) ~ colnames(clin_sub1)[ncol(clin_sub1)], clin_sub1)
  surv_object <- Surv(time = clin_sub1$patient.survDays, event = clin_sub1$patient.event)
  fit.coxph <- coxph(as.formula(paste("surv_object", "~", colnames(clin_sub1)[ncol(clin_sub1)])), data = clin_sub1)
  
  forest_p[[i]]<-ggforest(fit.coxph, data = clin_sub1)
}

forest_p[[1]]
forest_p[[2]]
forest_p[[3]]
forest_p[[4]]
forest_p[[5]]
forest_p[[6]]
forest_p[[7]]
forest_p[[8]]
forest_p[[9]]
forest_p[[10]]
forest_p[[11]]
forest_p[[12]]
forest_p[[13]]
forest_p[[14]]
forest_p[[15]]
```


```{r, include=FALSE}
library(MASS)
library(GGally)

clusterfinal<-readRDS("../data/clustersfinal.RDS")
clin_sub<-read.csv("../data/clin_sub.csv", header = T)

clin_sub$methygroup<-as.factor(clusterfinal)
```

## Variable selection
Based on single-parameter survival analysis, choose as predict variables.
```{r, warning=FALSE}
features<-c("patient.gender","patient.age_year", "patient.tumor_status","patient.tumor_grade",
            "patient.event", "patient.survDays", "methygroup")
clin_dat<-clin_sub[,features]
colnames(clin_dat)<-unlist(lapply(strsplit(colnames(clin_dat), '.', fixed = TRUE), '[', 2))  ## remove 'patien.xxx' in the colnames
colnames(clin_dat)[7]<-"MethyGroup"

### Age group
firstq<-summary(clin_dat$age_year)[2]
secondq<-summary(clin_dat$age_year)[4]
thirdq<-summary(clin_dat$age_year)[5]

clin_dat<-clin_dat %>%
    mutate(age_group = ifelse(age_year>=secondq, "Above_median","Below_median"),
           age_group1 = case_when(age_year <=firstq ~ "1st quantile",
                                  age_year >firstq & age_year <=secondq ~ "2nd quantile",
                                  age_year >secondq & age_year<=thirdq ~ "3rd quantile",
                                  age_year > thirdq ~ "4th quantile"))

ggpairs(clin_dat[, c("MethyGroup", "gender", "tumor_status","tumor_grade","age_group1")])

##Checnk correlation
clin_dat1<-clin_dat[,c("MethyGroup", "gender", "tumor_status","tumor_grade","age_group1")]
mapply(function(x, y) chisq.test(x, y)$p.value, clin_dat1[, -1], MoreArgs=list(clin_dat1[,1]))
mapply(function(x, y) chisq.test(x, y)$p.value, clin_dat1[, -2], MoreArgs=list(clin_dat1[,2]))
mapply(function(x, y) chisq.test(x, y)$p.value, clin_dat1[, -3], MoreArgs=list(clin_dat1[,3]))
mapply(function(x, y) chisq.test(x, y)$p.value, clin_dat1[, -4], MoreArgs=list(clin_dat1[,4]))
mapply(function(x, y) chisq.test(x, y)$p.value, clin_dat1[, -5], MoreArgs=list(clin_dat1[,5]))
```


## Training and test set
We randomly selected half of the observations as training data set, and the rest as our test data set.
```{r }
# randomly select half of the observations for training 
set.seed(123)
train = sample(1:nrow(clin_dat),nrow(clin_dat)/2)
test = (1:nrow(clin_dat))[-train]
clin_dat_train = clin_dat[train,]
clin_dat_test = clin_dat[test,]
```


## LDA
Note: QDA is also tested, but the model fitting is failed, which might be caused by collinearity. 
```{r LDA, warning=FALSE}
##LDA model
lda.fit = lda(event ~ gender +age_group1 + tumor_status + tumor_grade + MethyGroup, data = clin_dat_train)
lda.fit

##prediction for test data
lda.pred = predict(lda.fit, clin_dat_test)
table(lda.pred$class, clin_dat_test$event)
## error rate
mean(lda.pred$class != clin_dat_test$event, na.rm=TRUE)
```

## Multivariate survival model
```{r}
require("survival")
library("survminer")
library(ggpubr)

surv_object <- Surv(time =clin_dat$survDays, event = clin_dat$event)
fit.coxph <- coxph(surv_object ~ gender +age_group1 + tumor_status + tumor_grade + MethyGroup, data = clin_dat)

summary(fit.coxph)
```

# Appendix

The R code was produced in this environment:
```{r}
sessionInfo()
```
and in the following directory:
```{r}
getwd()
```

